#!/bin/sh

# Call this to load all modules 
# and bring up devices

load_modules()
{
    #modules=$(find /lib/modules 2>&1 | grep -E *.ko$ | sed 's/^\/.*\///' | sed 's/.ko//' |\
     #   grep "sd_mod\|ahci\|sata_*\|pata_*\|ehci_pci\|usb_storage\|virtio_blk\|virtio_pci")
    
    modules="ahci sd_mod ext4 virtio_blk virtio_pci"

    for mod in $modules; 
    do      
        echo "Loading $mod ..."
        modprobe $mod 
    done
}

launch_udev() 
{
    udevd="/lib/systemd/systemd-udevd"

    ${udevd} --daemon --resolve-names=never

    udevadm trigger --action=add
    udevadm settle
}

load_modules_and_devices() 
{
    #launch_udev     || echo "udev launched"       
    load_modules    || echo "Modules loaded"
}

#Disable kernel messages from popping onto the screen
echo 0 > /proc/sys/kernel/printk

PATH=/bin:/usr/bin:/sbin:/usr/sbin
export PATH

test  ! -d /dev && mkdir /dev && chmod 0755 /dev
test  ! -d /run && mkdir /run && chmod 0755 /run

mount -t proc proc /proc -o nosuid,noexec,nodev
mount -t sysfs sys /sys -o nosuid,noexec,nodev
mount -t devtmpfs dev /dev -o mode=0755,nosuid
mount -t tmpfs run /run -o nosuid,nodev,mode=0755

echo "Loading modules and devices ..."
load_modules_and_devices

exec /bin/sh
